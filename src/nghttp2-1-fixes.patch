From bf8f419ca9f2d8bce48591710aa25f08e3fc67f8 Mon Sep 17 00:00:00 2001
From: Tatsuhiro Tsujikawa <tatsuhiro.t@gmail.com>
Date: Wed, 11 Oct 2023 17:19:05 +0900
Subject: [PATCH] Fix build error when both clock_gettime and GetTickCount64
 are available

---
 lib/nghttp2_time.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/lib/nghttp2_time.c b/lib/nghttp2_time.c
index 2a5f1a6ff5..dd5a65591f 100644
--- a/lib/nghttp2_time.c
+++ b/lib/nghttp2_time.c
@@ -44,7 +44,9 @@ static uint64_t time_now_sec(void) {
 }
 #endif /* HAVE_GETTICKCOUNT64 */
 
-#ifdef HAVE_CLOCK_GETTIME
+#ifdef HAVE_GETTICKCOUNT64
+uint64_t nghttp2_time_now_sec(void) { return GetTickCount64() / 1000; }
+#elif defined(HAVE_CLOCK_GETTIME)
 uint64_t nghttp2_time_now_sec(void) {
   struct timespec tp;
   int rv = clock_gettime(CLOCK_MONOTONIC, &tp);
@@ -55,8 +57,6 @@ uint64_t nghttp2_time_now_sec(void) {
 
   return (uint64_t)tp.tv_sec;
 }
-#elif defined(HAVE_GETTICKCOUNT64)
-uint64_t nghttp2_time_now_sec(void) { return GetTickCount64() / 1000; }
 #else  /* !HAVE_CLOCK_GETTIME && !HAVE_GETTICKCOUNT64 */
 uint64_t nghttp2_time_now_sec(void) { return time_now_sec(); }
 #endif /* !HAVE_CLOCK_GETTIME && !HAVE_GETTICKCOUNT64 */
From c7536993cf3ab731bcfca8665aa4322920df05e7 Mon Sep 17 00:00:00 2001
From: Tatsuhiro Tsujikawa <tatsuhiro.t@gmail.com>
Date: Wed, 18 Oct 2023 21:13:57 +0900
Subject: [PATCH] Prefer clock_gettime if __CYGWIN__ defined

---
 lib/nghttp2_time.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/lib/nghttp2_time.c b/lib/nghttp2_time.c
index dd5a65591f..897556fe2c 100644
--- a/lib/nghttp2_time.c
+++ b/lib/nghttp2_time.c
@@ -32,7 +32,7 @@
 #  include <sysinfoapi.h>
 #endif /* HAVE_SYSINFOAPI_H */
 
-#ifndef HAVE_GETTICKCOUNT64
+#if !defined(HAVE_GETTICKCOUNT64) || defined(__CYGWIN__)
 static uint64_t time_now_sec(void) {
   time_t t = time(NULL);
 
@@ -42,9 +42,9 @@ static uint64_t time_now_sec(void) {
 
   return (uint64_t)t;
 }
-#endif /* HAVE_GETTICKCOUNT64 */
+#endif /* !HAVE_GETTICKCOUNT64 || __CYGWIN__ */
 
-#ifdef HAVE_GETTICKCOUNT64
+#if defined(HAVE_GETTICKCOUNT64) && !defined(__CYGWIN__)
 uint64_t nghttp2_time_now_sec(void) { return GetTickCount64() / 1000; }
 #elif defined(HAVE_CLOCK_GETTIME)
 uint64_t nghttp2_time_now_sec(void) {
@@ -57,6 +57,6 @@ uint64_t nghttp2_time_now_sec(void) {
 
   return (uint64_t)tp.tv_sec;
 }
-#else  /* !HAVE_CLOCK_GETTIME && !HAVE_GETTICKCOUNT64 */
+#else  /* (!HAVE_CLOCK_GETTIME || __CYGWIN__) && !HAVE_GETTICKCOUNT64 */
 uint64_t nghttp2_time_now_sec(void) { return time_now_sec(); }
-#endif /* !HAVE_CLOCK_GETTIME && !HAVE_GETTICKCOUNT64 */
+#endif /* (!HAVE_CLOCK_GETTIME || __CYGWIN__) && !HAVE_GETTICKCOUNT64 */
